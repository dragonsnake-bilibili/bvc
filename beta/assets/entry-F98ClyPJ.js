import{R as O}from"./interface-D6jMlKpV.js";import{A as Q}from"./utility-CQuTnSxM.js";import{u as W}from"./dialog-Buob4eiQ.js";import{e as ee}from"./easing-functions-Pc8ZxzqX.js";import{g as N,p as ae,b as te,d as se,c as j,t as le,a as oe,e as ne,f as L}from"./rendering-CVLbwh7J.js";import{_ as re,r as de}from"./ParagraphDisplay.vue_vue_type_script_setup_true_lang-Cg7Y1RDg.js";import{aj as ie}from"./resizeObserver-B_eoUIIx.js";import{u as ue}from"./emotes-DeEw5HnO.js";import{V as _e}from"./VAvatar-DYoKWv_6.js";import{w as me,v as S}from"./VColorPicker-DcrqMdfC.js";import{d as R,c as C,B as M,m as y,x as d,g as b,R as z,y as he,u as k,q as i,M as G,l as H,o as ce,r as be}from"./pinia-CYavoQC1.js";import{_ as pe,A as h,z as K,U as v}from"./VTextField-dhpxJfRw.js";import"./tag-DEJUn8pt.js";const fe={class:"container chat-container"},ge={class:"header"},ve={class:"username"},we=["src"],xe=["src"],ye=["src"],Ve=["src"],Be={class:"main"},Me=R({__name:"ChatBubbleDisplay",props:{chatConfig:{},globalConfig:{}},setup(r){ie(l=>({fd86a7b4:`${e.value.avatar_gap}px`,v8d4cf546:`${e.value.username_to_bubble}px`,v4c1387da:t.value.themed.name_color,v850ea7f0:`${e.value.username_to_badge}px`,v2348da1a:`${e.value.badge_gap}px`,v59482f58:t.value.themed.bubble_color,v3a23b014:`${e.value.bubble_padding}px`,v852bfcf6:`${e.value.bubble_radius}px`,v759c6df1:o.value}));const a=ue(),s=r,t=C(()=>({shared:s.chatConfig.shared,themed:s.chatConfig.themed.content})),e=C(()=>s.globalConfig.content),o=C(()=>{const l=e.value.bubble_radius,n=Math.PI*e.value.start_angle,_=Math.PI*e.value.end_angle,w=1.1;function p(m){const x=l*(Math.cos(m)+Math.sin(m)-Math.sqrt(Math.sin(2*m)))*w;return[x*Math.cos(m),x*Math.sin(m)]}const u=p(n),f=p(_);return`path("M 0 0 L ${u[0]} ${u[1]} A ${l} ${l} 0 0 0 ${f[0]} ${f[1]} Z")`});return(l,n)=>{const _=re;return y(),M("div",fe,[d(_e,{class:"chat-avatar",color:"primary",image:t.value.shared.avatar},null,8,["image"]),b("div",null,[b("div",ge,[b("span",ve,he(t.value.shared.username),1),t.value.shared.logos.manager?(y(),M("img",{key:0,class:"chat-logo",src:k(a).find_emote("special/房管")},null,8,we)):z("",!0),t.value.shared.logos.governor?(y(),M("img",{key:1,class:"chat-logo",src:k(a).find_emote("special/总督")},null,8,xe)):z("",!0),t.value.shared.logos.admiral?(y(),M("img",{key:2,class:"chat-logo",src:k(a).find_emote("special/提督")},null,8,ye)):z("",!0),t.value.shared.logos.captain?(y(),M("img",{key:3,class:"chat-logo",src:k(a).find_emote("special/舰长")},null,8,Ve)):z("",!0)]),b("div",Be,[d(me,{class:"chat-content",elevation:"0","max-width":"100%",width:"auto"},{default:i(()=>[d(_,{paragraph:t.value.shared.content},null,8,["paragraph"])]),_:1}),n[0]||(n[0]=b("div",{class:"visual-helper"},null,-1))])])])}}}),ze=pe(Me,[["__scopeId","data-v-52481b21"]]),Ce=R({__name:"ChatBubbleEditor",props:{modelValue:{required:!0},modelModifiers:{}},emits:["update:modelValue"],setup(r){const a=G(r,"modelValue"),s=C(()=>a.value.content);return(t,e)=>(y(),H(K,null,{default:i(()=>[d(h,null,{default:i(()=>[b("div",null,[e[2]||(e[2]=b("p",{style:{"text-align":"center"}},"用户名颜色",-1)),d(S,{modelValue:s.value.name_color,"onUpdate:modelValue":e[0]||(e[0]=o=>s.value.name_color=o),class:"mx-auto","show-swatches":"",swatches:[["#25885B"],["#638CF8"],["#FFFFFF"]]},null,8,["modelValue"])])]),_:1}),d(h,null,{default:i(()=>[b("div",null,[e[3]||(e[3]=b("p",{style:{"text-align":"center"}},"气泡颜色",-1)),d(S,{modelValue:s.value.bubble_color,"onUpdate:modelValue":e[1]||(e[1]=o=>s.value.bubble_color=o),class:"mx-auto","show-swatches":"",swatches:[["#2BEA28"],["#2960FB"],["#FFFFFF"]]},null,8,["modelValue"])])]),_:1})]),_:1}))}}),A="仿聊天气泡",$e=R({__name:"ChatBubbleGlobalConfig",props:{modelValue:{required:!0},modelModifiers:{}},emits:["update:modelValue"],setup(r){const a=G(r,"modelValue"),s={avatar_gap:16,username_to_badge:12,username_to_bubble:12,badge_gap:8,bubble_padding:20,bubble_radius:24,start_angle:.05,end_angle:.4},t=be(!1);ce(()=>{a.value.theme!==A&&(a.value.theme=A,a.value.content={...s}),t.value=!0});const e=C(()=>a.value.content);return(o,l)=>t.value?(y(),H(K,{key:0},{default:i(()=>[d(h,{cols:"6"},{default:i(()=>[d(v,{modelValue:e.value.avatar_gap,"onUpdate:modelValue":l[0]||(l[0]=n=>e.value.avatar_gap=n),modelModifiers:{number:!0},"hide-details":"",label:"头像到内容间距",suffix:"pixel"},null,8,["modelValue"])]),_:1}),d(h,{cols:"6"},{default:i(()=>[d(v,{modelValue:e.value.username_to_badge,"onUpdate:modelValue":l[1]||(l[1]=n=>e.value.username_to_badge=n),modelModifiers:{number:!0},"hide-details":"",label:"用户名到徽章距离",suffix:"pixel"},null,8,["modelValue"])]),_:1}),d(h,{cols:"6"},{default:i(()=>[d(v,{modelValue:e.value.username_to_bubble,"onUpdate:modelValue":l[2]||(l[2]=n=>e.value.username_to_bubble=n),modelModifiers:{number:!0},"hide-details":"",label:"用户名到气泡距离",suffix:"pixel"},null,8,["modelValue"])]),_:1}),d(h,{cols:"6"},{default:i(()=>[d(v,{modelValue:e.value.badge_gap,"onUpdate:modelValue":l[3]||(l[3]=n=>e.value.badge_gap=n),modelModifiers:{number:!0},"hide-details":"",label:"徽章间距",suffix:"pixel"},null,8,["modelValue"])]),_:1}),d(h,{cols:"6"},{default:i(()=>[d(v,{modelValue:e.value.bubble_padding,"onUpdate:modelValue":l[4]||(l[4]=n=>e.value.bubble_padding=n),modelModifiers:{number:!0},"hide-details":"",label:"气泡内间距",suffix:"pixel"},null,8,["modelValue"])]),_:1}),d(h,{cols:"6"},{default:i(()=>[d(v,{modelValue:e.value.bubble_radius,"onUpdate:modelValue":l[5]||(l[5]=n=>e.value.bubble_radius=n),modelModifiers:{number:!0},"hide-details":"",label:"气泡圆角尺寸",suffix:"pixel"},null,8,["modelValue"])]),_:1}),d(h,{cols:"6"},{default:i(()=>[d(v,{modelValue:e.value.start_angle,"onUpdate:modelValue":l[6]||(l[6]=n=>e.value.start_angle=n),modelModifiers:{number:!0},"hide-details":"",label:"起始角",suffix:"π"},null,8,["modelValue"])]),_:1}),d(h,{cols:"6"},{default:i(()=>[d(v,{modelValue:e.value.end_angle,"onUpdate:modelValue":l[7]||(l[7]=n=>e.value.end_angle=n),modelModifiers:{number:!0},"hide-details":"",label:"终止角",suffix:"π"},null,8,["modelValue"])]),_:1})]),_:1})):z("",!0)}}),ke="_hide-by-transparent_edd012b",q={"hide-by-transparent":ke},Ae={name_color:"#000000",bubble_color:"#ffffff"};async function Fe(r,a,s){const t=s.themes.content,e=a.measureText(r.shared.username),o=e.actualBoundingBoxLeft,l=e.actualBoundingBoxLeft+e.actualBoundingBoxRight,n=e.fontBoundingBoxAscent+e.fontBoundingBoxDescent,_=a.measureText("x"),w=_.actualBoundingBoxAscent+_.actualBoundingBoxDescent,p=e.fontBoundingBoxAscent-w/2,u=await ne(r.shared,s.shared.chat_logo_size),[f,m]=(()=>{if(u.length>0){const g=p-s.shared.chat_logo_size/2;return g<0?[-g,0]:[0,g]}return[0,-s.shared.chat_logo_size]})(),x=Math.max(f+n,m+s.shared.chat_logo_size),F=u.length>0?t.username_to_badge+u.length*s.shared.chat_logo_size+(u.length-1)*t.badge_gap:0,I=l+F,V=f+e.fontBoundingBoxAscent,U=a.font;a.canvas.height=x,a.canvas.width=I,a.font=U,a.textRendering="optimizeLegibility",a.fillStyle=r.themed.content.name_color,a.strokeStyle=r.themed.content.name_color,a.fillText(r.shared.username,o,V);let $=o+l+t.username_to_badge;for(const g of u)a.drawImage(g,$,m),g.close(),$+=s.shared.chat_logo_size+t.badge_gap;return s.shared.debug&&(L(a,{x:0,y:0},{x:0,y:a.canvas.height}),L(a,{x:l,y:0},{x:l,y:a.canvas.height}),L(a,{x:0,y:V},{x:a.canvas.width,y:V})),j(a.canvas)}async function X(r,a,s){const[t,e]=ae(s);e.font=`${a.shared.chat_font_size}px "${a.shared.font_family}"`,e.textRendering="optimizeLegibility",e.fillStyle="black";const o=a.themes.content,n=a.shared.chat_width_limit-a.shared.chat_avatar_size-o.avatar_gap-o.bubble_padding*2;n<=0&&W().show_dialog("warning","气泡可用宽度太小了！",`宽度只有${n}，很可能产生奇怪的结果`);const{image:_}=await de(r.shared.content,a.shared,n,t),w=t.height,p=t.width,u=w+o.bubble_padding*2,f=p+o.bubble_padding*2,m=await Fe(r,e,a),x=t.height,F=t.width,I=a.shared.chat_avatar_size+o.avatar_gap+Math.max(f,F),V=Math.max(a.shared.chat_avatar_size,x+o.username_to_bubble+u),U=e.font,$=await window.createImageBitmap(_),g=await window.createImageBitmap(m),Y=await window.createImageBitmap(await te(r.shared.avatar,e,a.shared.chat_avatar_size));e.canvas.height=V,e.canvas.width=I,e.font=U,e.textRendering="optimizeLegibility",e.drawImage(g,a.shared.chat_avatar_size+o.avatar_gap,0);const c={x:a.shared.chat_avatar_size+o.avatar_gap,y:x+o.username_to_bubble},Z=o.bubble_radius;e.fillStyle=r.themed.content.bubble_color;const[Re,J]=se(e,c,{width:f,height:u},Z,{fill:!0})[0];function T(B){const E=J*(Math.cos(B)+Math.sin(B)-Math.sqrt(Math.sin(2*B)))*1.1;return[E*Math.cos(B),E*Math.sin(B)]}const D=T(Math.PI*o.start_angle),P=T(Math.PI*o.end_angle);return e.beginPath(),e.moveTo(c.x,c.y),e.lineTo(c.x+D[0],c.y+D[1]),e.lineTo(c.x+P[0],c.y+P[1]),e.closePath(),e.fill(),e.drawImage($,c.x+o.bubble_padding,c.y+o.bubble_padding),e.drawImage(Y,0,0),{image:await j(t),canvas:t}}function Ie(r,a,s){if(s.shared.selected_mode.name==="danmaku")return{};a.classList.add(q["hide-by-transparent"]);const t=s.shared.main_axis==="horizontal"?"translateY":"translateX",e=60*N(s.shared.flow_direction);return{animation:[new Animation(new KeyframeEffect(a,[{transform:`${t}(${e}%)`,opacity:0},{transform:"none",opacity:1}],{duration:s.shared.enter_duration,easing:"ease-out",delay:r.shared.enter_millisecond+s.shared.lift_duration,fill:"forwards"}))],revoke:()=>{a.classList.remove(q["hide-by-transparent"])}}}class Ue extends O{size;render_pass2=void 0;#a;#e;#t;#s;#l;constructor(a,s,t,e){super(),this.size={width:a.width,height:a.height},this.#a=s,this.#e=a,this.#t=le(this.size,t),this.#s=t,this.#l=N(e)}render(a,s,t,e){const o=this.#a.get_ratio(e.current_time);if(o===1){const p=this.#e;return this.#e=void 0,p}const l=.6*this.#t.breadth*(1-o)*this.#l,n=oe({breadth:l,length:0},this.#s),_=o,w=a.globalAlpha;return a.globalAlpha=_,a.drawImage(this.#e,t.topleft.x+n.width,t.topleft.y+n.height),a.globalAlpha=w,!0}async free(){this.#e&&(this.#e.close(),this.#e=void 0)}}async function Le(r,a,s){const{image:t}=await X(r,a,s.canvas),e=await window.createImageBitmap(t);return a.shared.selected_mode.name==="danmaku"?{render:e,render_pass2:void 0}:new Ue(e,new Q({start:r.shared.enter_millisecond+a.shared.lift_duration,end:r.shared.enter_millisecond+a.shared.lift_duration+a.shared.enter_duration},{easing:ee.ease_out_sine}),a.shared.main_axis,a.shared.flow_direction)}const Ze={name:A,global_configure:$e,editor:Ce,display:ze,prepare_chat:r=>{r.themed.theme!==A&&(r.themed.content={...Ae})},render:X,prepare_entering_animation:Ie,prepare_rendering:Le};export{Ze as default};
