import{R as T}from"./interface-D6jMlKpV.js";import{u as G}from"./dialog-Buob4eiQ.js";import{p as S}from"./scene-previews.module-aXpXI_nu.js";import{g as W,t as E,a as V}from"./rendering-CVLbwh7J.js";import{S as J,A as N,C as Q,p as U,g as Z,a as g}from"./utility-CQuTnSxM.js";import"./pinia-CYavoQC1.js";import"./emotes-DeEw5HnO.js";class X{#e;#a;#t;#n;#s;constructor(o,e,h,t){this.#e=[{start:0,size:o,inuse:!1}],this.#a=e,this.#t=h,this.#n=t,this.#s=0}allocate(o,e,h){const[t,d]=(()=>{for(const[m,n]of this.#e.entries()){if(n.size<o)continue;if(!n.inuse)return[m,n];const b=Math.min(e,n.user_speed)*this.#a,s=n.user_speed*(h-n.user_enter_time-this.#t);if(e<=n.user_speed&&s<=b)continue;const w=n.user_enter_time+this.#t+this.#n/n.user_speed,f=e-n.user_speed;if(!(s-f*(w-h)<=b))return[m,n]}return[-1,this.#e[0]]})();if(t===-1)return{start:-1,handle:-1};const r=this.#s,z={start:d.start,size:o,inuse:!0,user_enter_time:h,user_speed:e,clear_handle:r};return this.#s+=1,d.size>o?(d.start=d.start+o,d.size=d.size-o,this.#e.splice(t,0,z)):this.#e.splice(t,1,z),{start:z.start,handle:r}}free(o){let e=this.#e.findIndex(t=>t.inuse&&t.clear_handle===o);if(e===-1)return;e>0&&this.#e[e-1].inuse===!1&&(this.#e[e-1].size+=this.#e[e].size,this.#e.splice(e,1),e=e-1),e<this.#e.length-1&&this.#e[e+1].inuse===!1&&(this.#e[e].size+=this.#e[e+1].size,this.#e.splice(e+1,1));const h=this.#e[e];if(h.inuse===!0){const t={start:h.start,size:h.size,inuse:!1};this.#e.splice(e,1,t)}}}function ee(a,o,e){const h=e.firstChild,t=U(h,o);for(const{element:s}of t)s.classList.add(S.danmaku,S[`danmaku-${a.shared.main_axis}-${a.shared.flow_direction}`]);const d=E({width:a.shared.scene_width,height:a.shared.scene_height},a.shared.main_axis),r=new X(d.breadth,a.shared.lift_duration,a.shared.enter_duration,d.length),z=[],m=[],n={exit_time:-1,animation:null};let u=0;for(const{chat:s,element:w}of t){const f=s.shared.enter_millisecond;let k=0;for(const{exit_time:M,handle:i}of z){if(M>f)break;r.free(i),k+=1}z.splice(0,k);const $=E({width:w.clientWidth,height:w.clientHeight},a.shared.main_axis),D=$.breadth+a.shared.chat_margin,y=$.length/a.shared.enter_duration,R=a.shared.enter_duration+d.length/y,C=f+R,{start:_,handle:x}=r.allocate(D,y,f);if(_===-1){u++;continue}const c=a.shared.main_axis==="horizontal"?"translateX":"translateY",A=W(a.shared.flow_direction),j=a.shared.main_axis==="horizontal"?[{top:`${_}px`,transform:`${c}(${-A*$.length}px)`},{top:`${_}px`,transform:`${c}(${A*d.length}px)`}]:[{left:`${_}px`,transform:`${c}(${-A*$.length}px)`},{left:`${_}px`,transform:`${c}(${A*d.length}px)`}],l=new Animation(new KeyframeEffect(w,j,{duration:R,delay:f,fill:"forwards"}));m.push(l),z.push({exit_time:C,handle:x}),C>n.exit_time&&(n.exit_time=C,n.animation=l)}G().show_dialog("warning","部分消息发射失败",`${u}条消息由于入场时刻太接近、最小间隔太大、场景太小而未能发射`);const b=Z(t,m,a);return{play:g(a.shared.delay_before_start,()=>{for(const s of m)s.play();return new Promise(s=>{if(n.animation===null){s();return}n.animation.addEventListener("finish",()=>s())})},a.shared.keep_after_end,()=>{for(const s of m)s.cancel();for(const{element:s}of t)s.classList.remove(S.danmaku,S[`danmaku-${a.shared.main_axis}-${a.shared.flow_direction}`]);for(const s of b)s()})}}async function te(a,o,e,h){const t={width:e.shared.scene_width,height:e.shared.scene_height},r=new OffscreenCanvas(t.width,t.height).getContext("2d"),m=new OffscreenCanvas(0,0).getContext("2d"),n=e.shared.fps,u=1e3/n,b=Math.ceil(e.shared.delay_before_start/u);let s=Math.ceil((o.at(-1).shared.enter_millisecond+e.shared.enter_duration)/u);const w=Math.ceil(e.shared.keep_after_end/u);let f=b+s+w;const k=W(e.shared.flow_direction),$={x:e.shared.main_axis==="vertical"||e.shared.flow_direction==="inverse"?0:t.width,y:e.shared.main_axis==="horizontal"||e.shared.flow_direction==="inverse"?0:t.height},D={topleft:{x:0,y:0},bottomright:{x:t.width,y:t.height}},y=E(t,e.shared.main_axis),R=new X(y.breadth,e.shared.lift_duration,e.shared.enter_duration,y.length),C=await J.build(a,n,t);let _=0;for(r.clearRect(0,0,t.width,t.height),r.fillStyle=e.shared.background,r.fillRect(0,0,t.width,t.height),_=0;_<b;_++)await C.add_frame(r),h(_/f*100);const x=o.map(l=>({chat:l,ccb:void 0,movement_controller:void 0,allocation_handle:void 0})),c={current_frame:0,current_time:0,time_delta:-1};for(r.font=`${e.shared.chat_font_size}px "${e.shared.font_family}"`,r.textRendering="optimizeLegibility";c.current_frame<w+s;c.current_time+=u,c.current_frame+=1,c.time_delta=u){const l=[];let M=0;for(const i of x){const{chat:v,ccb:O}=i;if(c.current_time<v.shared.enter_millisecond)break;if(M+=1,O){l.push(i);continue}const p=await e.shared.selected_theme.prepare_rendering(v,e,m),P=p instanceof T?p.size:{height:p.render.height,width:p.render.width},L=E(P,e.shared.main_axis),Y=L.breadth+e.shared.chat_margin,B=L.length/e.shared.enter_duration,{start:H,handle:q}=R.allocate(Y,B,v.shared.enter_millisecond);if(H===-1){p instanceof T?await p.free():(p.render.close(),p.render_pass2?.image.close());continue}const I=v.shared.enter_millisecond+e.shared.enter_duration+y.length/B;i.movement_controller=new N({start:v.shared.enter_millisecond,end:I},{value:{start:0,end:L.length+y.length}});const F=Math.ceil(I/u);s=Math.max(s,F),f=Math.max(f,b+w+s),i.allocation_handle=q;const K=V({length:k===1?-L.length:0,breadth:H*k},e.shared.main_axis);i.ccb=new Q(p,{x:$.x+k*K.width,y:$.y+k*K.height}),l.push(i)}x.splice(0,M,...l.splice(0)),M=0;for(const i of x){const{ccb:v,allocation_handle:O,movement_controller:p}=i;if(v===void 0)break;M++;const P=V({length:p.get_value(c.current_time)*k,breadth:0},e.shared.main_axis);await v.update_position(P,D)?(await v.free(),R.free(O)):l.push(i)}x.splice(0,M,...l.splice(0)),r.clearRect(0,0,t.width,t.height),r.fillStyle=e.shared.background,r.fillRect(0,0,t.width,t.height);for(const{ccb:i}of x){if(i===void 0)break;i.render(r,m,c)}for(const{ccb:i}of x){if(i===void 0)break;i.render_pass2(r,m,c)}await C.add_frame(r),_++,h(_/f*100)}for(const{ccb:l}of x)l!==void 0&&l.free();return(await(await C.close()).json()).name}const de={name:"danmaku",display_name:"弹幕",preview:ee,render:te};export{de as default};
