import{u as $}from"./dialog-Buob4eiQ.js";import{u as j}from"./emotes-DeEw5HnO.js";import{C as D,c as J,f as b}from"./rendering-CVLbwh7J.js";import{d as K,B as y,m as B,F as T,C as F,R as A,y as L,j as O,c as E}from"./pinia-CYavoQC1.js";function W(r){return new RegExp("\\p{White_Space}","u").test(r)?{space:!0}:new RegExp("\\p{Number}","u").test(r)?{space:!1,latin_cluster:!0,avoid:{start:!1,end:!1},auto_space_class:"non-CJK",space_padding:{before:{ratio:0},after:{ratio:0}}}:new RegExp("\\p{Script=Han}","u").test(r)?{space:!1,latin_cluster:!1,avoid:{start:!1,end:!1},auto_space_class:"CJK",space_padding:{before:{ratio:.5},after:{ratio:.5}}}:new RegExp("\\p{Script=Hiragana}|\\p{Script=Katakana}","u").test(r)?{space:!1,latin_cluster:!1,avoid:{start:!1,end:!1},auto_space_class:"CJK",space_padding:{before:{ratio:.5},after:{ratio:.5}}}:/[A-Za-z]/.test(r)?{space:!1,latin_cluster:!0,avoid:{start:!1,end:!1},auto_space_class:"non-CJK",space_padding:{before:{ratio:0},after:{ratio:0}}}:/[-\u2010\u2011\u2012\u2013\u2014\u2212\uFF0D]/.test(r)?{space:!1,latin_cluster:!0,avoid:{start:!1,end:!1},auto_space_class:"non-CJK",space_padding:{before:{ratio:0},after:{ratio:0}}}:"([{<".includes(r)?{space:!1,latin_cluster:!1,avoid:{start:!1,end:!0},auto_space_class:"non-CJK",space_padding:{before:{ratio:0},after:{ratio:0}}}:"（〔［｛〈《「『【“‘".includes(r)?{space:!1,latin_cluster:!1,avoid:{start:!1,end:!0},space_padding:{before:{ratio:.8,reducible_to:.4},after:{ratio:.2}}}:")]}>!,.:;?".includes(r)?{space:!1,latin_cluster:!1,avoid:{start:!0,end:!1},auto_space_class:"non-CJK",space_padding:{before:{ratio:0},after:{ratio:0}}}:"）〕］｝〉》」』】”’！，。：；？".includes(r)?{space:!1,latin_cluster:!1,avoid:{start:!0,end:!1},space_padding:{before:{ratio:.2},after:{ratio:.8,reducible_to:.4}}}:{space:!1,latin_cluster:!1,avoid:{start:!1,end:!1},space_padding:{before:{ratio:0},after:{ratio:0}}}}const H=(()=>{let r=!1;return()=>{const e=r?"yellow":"blue";return r=!r,e}})();function P(r,e){const t=r.measureText("a a").width-r.measureText("aa").width,s=r.measureText("x");return{em:e.chat_font_size,ex:s.actualBoundingBoxAscent+s.actualBoundingBoxDescent,space:t,font_ascent:s.fontBoundingBoxAscent,font_descent:s.fontBoundingBoxDescent,maximum_line_width:0,target_line_width:0}}class v{append(e){return new w(this).append(e)}render(e,t,s,n,o){if(s.debug){const i=H(),c=e.strokeStyle;e.strokeStyle=i,e.strokeRect(t.x,t.y-this.shape.above_baseline,this.shape.width,this.shape.above_baseline+this.shape.below_baseline),e.strokeStyle=c}}}class w extends v{shape={width:0,above_baseline:0,below_baseline:0};space_after=!1;auto_space_class=[void 0,void 0];space_padding={before:{ratio:0},after:{ratio:0}};#e;#t;#s;#a;constructor(e){super(),this.#e=[],this.#t=[],this.shape=e.shape,this.space_after=e.space_after,this.auto_space_class=[...e.auto_space_class],this.#i(e)}render(e,t,s,n,o,i){s.debug&&console.log(this.#e,this.#t);const c=(()=>{if(this.#e.length===1||!i?.is_toplevel||n.alignment==="center")return 0;const h=o.target_line_width;return i.is_last_line&&this.shape.width<h*n.justification.last||!i.is_last_line&&!n.justification.normal?0:(h-this.shape.width)/(this.#e.length-1)})(),a=this.shape.width+(this.#e.length-1)*c;let l=(()=>{if(!i?.is_toplevel)return t.x;switch(n.alignment){case"left":return t.x;case"center":return t.x+(o.target_line_width-a)/2;case"right":return t.x+o.target_line_width-a}})();const p=this.#s??1;for(const[h,d]of this.#e.entries()){s.debug&&this.#t[h]>0&&b(e,{x:l,y:t.y},{x:l+this.#t[h]*o.space,y:t.y},this.#t[h]===1?"red":"green"),l+=this.#t[h]*o.space;const f=(()=>{const g=Math.max(0,o.em-d.shape.width),m=d.space_padding.before.reducible_to??d.space_padding.before.ratio,x=d.space_padding.after.reducible_to??d.space_padding.after.ratio,k=d.space_padding.before.ratio-m,I=d.space_padding.after.ratio-x;return{before:g*(m+k*p),after:g*(x+I*p)}})();f.before>0&&h!==0&&(s.debug&&b(e,{x:l,y:t.y},{x:l+f.before,y:t.y},"#ff00ff"),l+=f.before),d.render(e,{x:l,y:t.y},s,n,o),l+=d.shape.width,f.after>0&&h!==this.#e.length-1&&(s.debug&&b(e,{x:l,y:t.y},{x:l+f.after,y:t.y},"#ff00ff"),l+=f.after),s.debug&&h!==this.#e.length-1&&b(e,{x:l,y:t.y},{x:l+c,y:t.y},"#00ffff"),l+=c}}calculate_shape(e,t,s){this.#n(),this.shape={width:0,above_baseline:0,below_baseline:0};let n=0;for(const[o,i]of this.#e.entries()){i.calculate_shape(e,t,s),this.shape.width+=this.#t[o]*s.space;const c=Math.max(0,s.em-i.shape.width);if(o!==0){const a=i.space_padding.before.reducible_to??i.space_padding.before.ratio;this.shape.width+=c*a,n+=c*(i.space_padding.before.ratio-a)}if(o!==this.#e.length-1){const a=i.space_padding.after.reducible_to??i.space_padding.after.ratio;this.shape.width+=c*a,n+=c*(i.space_padding.after.ratio-a)}this.shape.width+=i.shape.width,this.shape.above_baseline=Math.max(this.shape.above_baseline,i.shape.above_baseline),this.shape.below_baseline=Math.max(this.shape.below_baseline,i.shape.below_baseline)}if(this.shape.width+=n,this.shape.width>s.maximum_line_width){const o=this.shape.width-s.maximum_line_width;o<=n?(this.shape.width=s.maximum_line_width,this.#s=(n-o)/n):(this.shape.width-=n,this.#s=0)}else this.#s=void 0}async prepare_resources(e){for(const t of this.#e)await t.prepare_resources(e)}append(e){return this.auto_space_class[1]=e.auto_space_class[1],this.space_after=e.space_after,this.#i(e),this}pop(){if(this.#a===void 0)return this.#e.pop();const e=this.#a;return this.#a=void 0,this.#e=this.#e.slice(0,-e.#e.length),e}#i(e){e instanceof w?(this.#e.push(...e.#e),this.#a=e):(this.#e.push(e),this.#a=void 0)}#n(){this.#t.splice(0);let e,t=!1;for(const[s,n]of this.#e.entries())t||(e===void 0||n.auto_space_class[0]===void 0||e===n.auto_space_class[0]?this.#t.push(0):this.#t.push(.25)),t=!1,e=n.auto_space_class[1],n.space_after&&s!==this.#e.length-1&&(this.#t.push(1),t=!0)}}class C extends v{shape={width:0,above_baseline:0,below_baseline:0};space_after=!1;auto_space_class=[void 0,void 0];space_padding={before:{ratio:0},after:{ratio:0}};#e;#t;constructor(e){super(),this.#e=e}render(e,t,s,n,o){super.render(e,t,s,n,o);const i=this.#t??0;n.operations.fill&&e.fillText(this.#e,t.x+i,t.y),n.operations.stroke&&e.strokeText(this.#e,t.x+i,t.y)}calculate_shape(e,t){const s=e.measureText(this.#e);this.space_padding.before.ratio>0||this.space_padding.after.ratio>0?(this.#t=s.actualBoundingBoxLeft,this.shape={width:s.actualBoundingBoxRight+s.actualBoundingBoxLeft,above_baseline:s.fontBoundingBoxAscent,below_baseline:s.fontBoundingBoxDescent}):this.shape={width:s.actualBoundingBoxRight,above_baseline:s.fontBoundingBoxAscent,below_baseline:s.fontBoundingBoxDescent}}async prepare_resources(e){}}class U extends v{shape={width:0,above_baseline:0,below_baseline:0};space_after=!1;auto_space_class=[void 0,void 0];space_padding={before:{ratio:0},after:{ratio:0}};#e;constructor(e){super();const t=Number.parseFloat(e);if(Number.isNaN(t)){this.#e="0px";return}this.#e=e.endsWith("em")?`${t}em`:`${t}px`}render(e,t,s,n,o){super.render(e,t,s,n,o)}calculate_shape(e,t,s){const n=Number.parseFloat(this.#e);this.shape={width:this.#e.endsWith("px")?n:n*s.em,below_baseline:0,above_baseline:0}}async prepare_resources(e){}}class V extends v{shape={width:0,above_baseline:0,below_baseline:0};space_after=!1;auto_space_class=[void 0,void 0];space_padding={before:{ratio:0},after:{ratio:0}};#e;#t=void 0;constructor(e){super(),this.#e=e}render(e,t,s,n,o){super.render(e,t,s,n,o),e.drawImage(this.#t,t.x,t.y-this.shape.above_baseline)}calculate_shape(e,t){const s=e.textBaseline;e.textBaseline="bottom";const n=e.measureText("").alphabeticBaseline;e.textBaseline=s,this.shape={width:t.chat_emote_size,above_baseline:t.chat_emote_size-n,below_baseline:n}}async prepare_resources(e){const{images:t}=e,s=`emote://${this.#e}@${this.shape.width}`,n=t.get(s);if(n!==void 0){this.#t=n;return}const o=j().find_emote(this.#e),i=await(await fetch(o)).blob(),c=await window.createImageBitmap(i,{resizeHeight:this.shape.width,resizeWidth:this.shape.width,resizeQuality:"high"});this.#t=c,t.set(s,c)}}class q extends v{shape={width:0,above_baseline:0,below_baseline:0};space_after=!1;auto_space_class=[void 0,void 0];space_padding={before:{ratio:0},after:{ratio:0}};#e;#t;#s;#a;#i=void 0;constructor(e){super(),this.auto_space_class=[e.auto_space_class,e.auto_space_class],this.#e=e.image,this.#t=e.size,this.#s=e.baseline,this.#a=e.reference_line_offset}render(e,t,s,n,o){const i=this.shape.above_baseline>0?t.y-this.shape.above_baseline:t.y+this.shape.below_baseline-this.#t.height;e.drawImage(this.#i,t.x,i),super.render(e,t,s,n,o),s.debug&&b(e,{x:t.x,y:i+this.#a},{x:t.x+this.#t.width,y:i+this.#a})}calculate_shape(e,t,s){const n=this.#t.height-this.#a,o=this.#a,i=(()=>{if(typeof this.#s=="number")return this.#s;switch(this.#s){case"bottom":return-s.font_descent;case"default":return 0;case"middle":return s.ex/2;case"sub":return-t.chat_font_size/5;case"super":return t.chat_font_size/3;case"top":return s.font_ascent}})();this.shape={width:this.#t.width,above_baseline:Math.max(0,o+i),below_baseline:Math.max(0,n-i)}}async prepare_resources(e){const{images:t}=e,s=`image://${this.#e}@${this.#t.width}x${this.#t.height}`,n=t.get(s);if(n!==void 0){this.#i=n;return}const o=await(await fetch(this.#e)).blob(),i=await window.createImageBitmap(o,{resizeHeight:this.#t.height,resizeWidth:this.#t.width,resizeQuality:"high"});this.#i=i,t.set(s,i)}}class Y extends v{shape={width:0,above_baseline:0,below_baseline:0};space_after=!1;auto_space_class=[void 0,void 0];space_padding={before:{ratio:0},after:{ratio:0}};#e;constructor(e){super(),this.#e=e}render(e,t,s){e.fillStyle=this.#e}calculate_shape(e,t){}async prepare_resources(e){}}function Q(r){const e=/^\[:(?<type>[^:]+):(?<parameter>.+?):\]/,t=[];let s=-1,n=-1,o=!1;const i=()=>{if(s<n){const a=new C(r.slice(s,n));if(a.auto_space_class=["non-CJK","non-CJK"],o){const l=t.pop();t.push(l.append(a)),o=!1}else t.push(a);s=-1,n=-1}},c=a=>{if(r[a]==="["){const p=r.slice(a).match(e);if(p!==null){if(p.groups.type==="emote")return[{box:new V(p.groups.parameter),action:"normal",avoid_end:!1},a+p[0].length-1];if(p.groups.type==="space")return[{box:new U(p.groups.parameter),action:"normal",avoid_end:!1},a+p[0].length-1];if(p.groups.type==="inline-image"){const h=JSON.parse(p.groups.parameter);return[{box:new q(h),action:h.disable_line_break.before&&t.length>0?"append":"normal",avoid_end:h.disable_line_break.after},a+p[0].length-1]}else if(p.groups.type==="color")return[{box:new Y(p.groups.parameter),action:"normal",avoid_end:!1},a+p[0].length-1]}}const l=W(r[a]);if(l.space)return[{box:void 0,action:"break",avoid_end:void 0},a];if(l.latin_cluster)return s>=n&&(s=a),n=a+1,[{box:void 0,action:"normal",avoid_end:void 0},a];{const p=new C(r[a]);return p.auto_space_class=[l.auto_space_class,l.auto_space_class],p.space_padding=l.space_padding,[{box:p,action:l.avoid.start&&t.at(-1)!==void 0?"append":"normal",avoid_end:l.avoid.end},a]}};for(let a=0;a<r.length;a++){const[{box:l,action:p,avoid_end:h},d]=c(a);if(a=d,(l!==void 0||l===void 0&&p==="break")&&(i(),l===void 0&&p==="break"&&t.length>0&&(t.at(-1).space_after=!0)),l!==void 0&&(o||p==="append")){const f=t.pop();t.push(f.append(l)),o=!1}else l!==void 0&&t.push(l);h!==void 0&&(o=h)}return i(),t}function Z(r,e,t,s){const n=Array.from({length:r.length+1}).fill(Number.POSITIVE_INFINITY);n[0]=0;const o=Array.from({length:r.length+1}).fill(-1);for(let a=0;a<=r.length;a++)for(let l=0;l<a;l++){const p=new w(r[l]);for(const g of r.slice(l+1,a))p.append(g);p.calculate_shape(e,t,s);const h=p.shape.width;if(h>s.maximum_line_width)continue;const d=a===r.length?0:Math.pow(s.maximum_line_width-h,3),f=n[l]+d;f<n[a]&&(n[a]=f,o[a]=l)}const i=[];let c=r.length;for(;c>0;){const a=o[c],l=new w(r[a]);for(const p of r.slice(a+1,c))l.append(p);i.push(l),c=a}return i.reverse(),[i,n[r.length]]}function G(r,e,t,s){const n=[new w(r[0])];let o=0,i=0;for(const c of r.slice(1)){const a=n.at(-1);a.append(c),a.calculate_shape(e,t,s),a.shape.width>s.maximum_line_width?(a.pop(),n.push(new w(c)),o+=Math.pow(s.maximum_line_width-i,3)):i=a.shape.width}return[n,o]}function X(r,e,t,s,n){let o=0,i=0,c=0;for(const a of r){a.calculate_shape(e,t,s);const l=o+a.shape.above_baseline+a.shape.below_baseline;if(l>(n?.maximum_height??Number.POSITIVE_INFINITY)||(o=l,i=Math.max(i,a.shape.width),c+=1,c===(n?.maximum_lines??Number.POSITIVE_INFINITY)))break}if(c=Math.min(c,n?.maximum_lines??r.length),r.length>c){if(r.splice(c),r.length===0)$().show_dialog("warning","高度限制使段落无法渲染","当前高度限制对于所用字体或者图片尺寸而言太小以至于无法渲染任何内容。尝试调整配置");else if(n?.ellipsis){const a=r.at(-1),l=e.measureText("…"),p=l.actualBoundingBoxLeft+l.actualBoundingBoxRight;if(o-=a.shape.above_baseline+a.shape.below_baseline,a.shape.width+p>=s.maximum_line_width){let h=s.maximum_line_width-a.shape.width;for(;h<p;){const d=a.pop();if(d===void 0){$().show_dialog("warning","段落可用宽度太小以至于无法插入省略号","配置的段落宽度过小或字体大小过大，以至于最后一行全部元素均移除后仍不足以放置一个省略号。当前渲染会产生奇怪的结果。尝试调整配置。");break}h+=d.shape.width}}a.append(new C("…")),a.calculate_shape(e,t,s),o+=a.shape.above_baseline+a.shape.below_baseline,i=Math.max(i,a.shape.width)}}return{width:i,height:o}}async function ee(...r){const[e,t,s,n,o]=r,i=t,{used_canvas:c,context:a}=(()=>{if(n)return{used_canvas:n,context:n.getContext("2d")};const _=new OffscreenCanvas(0,0),u=_.getContext("2d");return u.font=o?.canvas_configurations?.font??`${i.chat_font_size}px "${i.font_family}"`,u.fillStyle=o?.canvas_configurations?.fill_style??"black",u.strokeStyle=o?.canvas_configurations?.stroke_style??"black",{used_canvas:_,context:u}})();a.textRendering="optimizeLegibility";const l=P(a,i);l.maximum_line_width=s;const p=Q(e),h=(o?.algorithm??"greedy")==="greedy"?G:Z,[d,f]=h(p,a,i,l);i.debug&&console.log(d,f);const{width:g,height:m}=X(d,a,i,l,o?.limit_height);l.target_line_width=g;const x={images:new Map};for(const _ of d)await _.prepare_resources(x);const k=(()=>{const _=o?.justification?.last??!1;return{operations:{fill:o?.operations?.fill??!0,stroke:o?.operations?.stroke??!1},alignment:o?.alignment??"left",justification:{normal:o?.justification?.normal??!0,last:typeof _=="number"?_:_?0:2}}})(),I=a.font,M=a.textRendering;return{size:{width:g,height:m},render:(_,u)=>{const N={font:_.font,text_rendering:_.textRendering};_.font=I,_.textRendering=M,i.debug&&(b(_,{x:u.x,y:u.y},{x:u.x,y:u.y+m}),b(_,{x:u.x+g-1,y:u.y},{x:u.x+g-1,y:u.y+m}));let z=u.y;for(const[R,S]of d.entries())z+=S.shape.above_baseline,S.render(_,{x:u.x,y:z},i,k,l,{is_toplevel:!0,is_last_line:R===d.length-1}),z+=S.shape.below_baseline;_.font=N.font,_.textRendering=N.text_rendering},release:async()=>{for(const _ of x.images.values())_.close();x.images.clear()},canvas:c}}async function re(r,e,t,s,n){const o=await ee(r,e,t,s,n),i=o.canvas.getContext("2d"),c=new D(i);return o.canvas.height=o.size.height,o.canvas.width=o.size.width,c.apply(i),o.render(i,{x:0,y:0}),o.release(),{image:await J(o.canvas),canvas:o.canvas}}async function le(r,e,t,s,n,o){const i=r instanceof Blob?URL.createObjectURL(r):r,c=t*e.height;return{content:`[:inline-image:${JSON.stringify({image:i,size:e,reference_line_offset:c,baseline:s,auto_space_class:n,disable_line_break:o})}:]`,url:i}}const te={key:0},ae=["src"],ce=K({__name:"ParagraphDisplay",props:{paragraph:{}},setup(r){const e=j(),t=r,s=E(()=>{const n=/\[:(?<type>[^:]+):(?<parameter>[^:]+):\]/g,o=t.paragraph.matchAll(n);let i=0;const c=[];for(const a of o){const l=(()=>{if(a.groups.type==="emote"){const p=e.find_emote(a.groups.parameter);return p===void 0?null:{type:"image",src:p,key:`image-${p}`}}else if(a.groups.type==="space")return{type:"space",width:a.groups.parameter,key:crypto.randomUUID()};return null})();l!==null&&(i<a.index&&c.push({type:"text",content:t.paragraph.slice(i,a.index),key:`text-${t.paragraph.slice(i,a.index)}`}),c.push(l),i=a.index+a[0].length)}return i<t.paragraph.length&&c.push({type:"text",content:t.paragraph.slice(i),key:`text-${t.paragraph.slice(i)}`}),c});return(n,o)=>(B(!0),y(T,null,F(s.value,(i,c)=>(B(),y(T,{key:`${c}-${i.key}`},[i.type==="text"?(B(),y("span",te,L(i.content),1)):i.type==="image"?(B(),y("img",{key:1,class:"chat-content-image",src:i.src},null,8,ae)):i.type==="space"?(B(),y("span",{key:2,style:O(`width: ${i.width}; display: inline-block`)},null,4)):A("",!0)],64))),128))}});export{ce as _,le as b,ee as p,re as r};
