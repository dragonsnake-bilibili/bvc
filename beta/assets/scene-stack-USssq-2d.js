import{g as H,S as q,c as P,R as D,t as K,A as F,a as B,C as G,p as I,b as J,d as N}from"./utility-CjXVDNSm.js";import{p as y}from"./scene-previews.module-Bgk_TgTA.js";import{e as Q}from"./easing-functions-BZdVlQmR.js";function T(a,e){const c=[];for(const[s,{chat:_,element:r}]of e.entries()){const o=K({width:r.clientWidth,height:r.clientHeight},a.shared.main_axis).length,f=s===0?0:a.shared.chat_margin,d=H(a.shared.flow_direction)*(o+f),t=a.shared.main_axis==="horizontal"?"translateX":"translateY";c.push({keyframe:[{transform:"none",easing:"ease-in"},{transform:`${t}(${d}px)`}],start_time:_.shared.enter_millisecond})}return c}function U(a,e,c){const s=I(c,e),_=T(a,s),r=document.createElement("div");r.classList.add(y["root-peano-container"],y[`root-peano-container-${a.shared.main_axis}-${a.shared.flow_direction}`]),c.append(r);let m=r;const o=[];for(const t of _){const p=document.createElement("div");m.append(p),o.push(new Animation(new KeyframeEffect(p,t.keyframe,{delay:t.start_time,duration:a.shared.lift_duration,fill:"forwards"}))),m=p}m.classList.add(y["innermost-container"],y[`innermost-container-${a.shared.main_axis}`]),m.style=`gap: ${a.shared.chat_margin}px`;const f=s.map(({element:t})=>t);a.shared.flow_direction==="inverse"&&f.reverse(),m.append(...f);const d=J(s,o,a);return{play:N(a.shared.delay_before_start,()=>{for(const t of o)t.play();return new Promise(t=>{o.at(-1).addEventListener("finish",()=>t())})},a.shared.keep_after_end,()=>{for(const t of o)t.cancel();r.remove(),c.append(...s.map(({element:t})=>t));for(const t of d)t()})}}async function Z(a,e,c){const s={width:e.shared.scene_width,height:e.shared.scene_height},_=new OffscreenCanvas(s.width,s.height),r=_.getContext("2d"),o=new OffscreenCanvas(0,0).getContext("2d"),f=e.shared.fps,d=1e3/f,t=Math.ceil(e.shared.delay_before_start/d),p=Math.ceil((a.at(-1).shared.enter_millisecond+e.shared.enter_duration+e.shared.lift_duration)/d),C=Math.ceil(e.shared.keep_after_end/d),$=t+p+C,b=H(e.shared.flow_direction),E={x:e.shared.main_axis==="vertical"||e.shared.flow_direction==="inverse"?0:s.width,y:e.shared.main_axis==="horizontal"||e.shared.flow_direction==="inverse"?0:s.height},V={topleft:{x:0,y:0},bottomright:{x:s.width,y:s.height}},u=await q.build(f,s);let w=0;{r.fillStyle=e.shared.background,r.fillRect(0,0,s.width,s.height);const l=await P(_);for(w=0;w<t;w++)await u.add_frame(l),c(w/$*100)}const v=a.map(l=>({chat:l,ccb:void 0})),k=[],h={current_frame:0,current_time:0,time_delta:-1};let R=0,S=0;for(;h.current_frame<C+p;h.current_time+=d,h.current_frame+=1,h.time_delta=d){for(const n of v){const{chat:i,ccb:j}=n;if(h.current_time<i.shared.enter_millisecond)break;if(j)continue;const x=await e.shared.selected_theme.prepare_rendering(i,e,o),Y=x instanceof D?x.size:{height:x.render.height,width:x.render.width},z=K(Y,e.shared.main_axis);k.push(new F({start:i.shared.enter_millisecond,end:i.shared.enter_millisecond+e.shared.lift_duration},{easing:Q.ease_out_cubic,value:{start:0,end:z.length+e.shared.chat_margin}}));const O=B({length:R+e.shared.chat_margin+(b===1?z.length:0),breadth:0},e.shared.main_axis);n.ccb=new G(x,{x:E.x-b*O.width,y:E.y-b*O.height}),R+=e.shared.chat_margin+z.length}let l=0,A=S;for(const n of k){const i=n.get_value(h.current_time);A+=i,h.current_time>=n.time.end&&(S+=i,l++)}k.splice(0,l);const W=B({length:A*b,breadth:0},e.shared.main_axis),L=[];let M=0;for(const n of v){const{ccb:i}=n;if(i===void 0)break;M++,await i.update_position(W,V)?await i.free():L.push(n)}v.splice(0,M,...L.splice(0)),r.fillStyle=e.shared.background,r.fillRect(0,0,s.width,s.height);for(const{ccb:n}of v){if(n===void 0)break;n.render(r,o,h)}for(const{ccb:n}of v){if(n===void 0)break;n.render_pass2(r,o,h)}const X=await P(_);await u.add_frame(X),w++,c(w/$*100)}for(const{ccb:l}of v)l!==void 0&&l.free();return(await(await u.close()).json()).name}const re={name:"stack",display_name:"堆叠",preview:U,render:Z};export{re as default};
