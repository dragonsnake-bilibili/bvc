import{R as Y}from"./interface-D6jMlKpV.js";import{p as y}from"./scene-previews.module-aXpXI_nu.js";import{e as q}from"./easing-functions-Pc8ZxzqX.js";import{g as H,t as K,a as B}from"./rendering-CVLbwh7J.js";import{S as D,A as F,C as G,p as I,g as J,a as N}from"./utility-CQuTnSxM.js";import"./emotes-DeEw5HnO.js";import"./pinia-CYavoQC1.js";function Q(a,l){const e=[];for(const[o,{chat:t,element:v}]of l.entries()){const _=K({width:v.clientWidth,height:v.clientHeight},a.shared.main_axis).length,i=o===0?0:a.shared.chat_margin,m=H(a.shared.flow_direction)*(_+i),r=a.shared.main_axis==="horizontal"?"translateX":"translateY";e.push({keyframe:[{transform:"none",easing:"ease-in"},{transform:`${r}(${m}px)`}],start_time:t.shared.enter_millisecond})}return e}function T(a,l,e){const o=e.firstChild,t=I(o,l),v=Q(a,t),s=document.createElement("div");s.classList.add(y["root-peano-container"],y[`root-peano-container-${a.shared.main_axis}-${a.shared.flow_direction}`]),e.append(s);let _=s;const i=[];for(const r of v){const f=document.createElement("div");_.append(f),i.push(new Animation(new KeyframeEffect(f,r.keyframe,{delay:r.start_time,duration:a.shared.lift_duration,fill:"forwards"}))),_=f}_.append(o),o.classList.remove("chat-list-container-default"),o.classList.add(y[`chat-list-container-${a.shared.main_axis}-${a.shared.flow_direction}`]);const m=J(t,i,a);return{play:N(a.shared.delay_before_start,()=>{for(const r of i)r.play();return new Promise(r=>{i.at(-1).addEventListener("finish",()=>r())})},a.shared.keep_after_end,()=>{for(const r of i)r.cancel();e.append(o),s.remove(),o.classList.add("chat-list-container-default"),o.classList.remove(y[`chat-list-container-${a.shared.main_axis}-${a.shared.flow_direction}`]);for(const r of m)r()})}}async function U(a,l,e,o){const t={width:e.shared.scene_width,height:e.shared.scene_height},s=new OffscreenCanvas(t.width,t.height).getContext("2d"),i=new OffscreenCanvas(0,0).getContext("2d"),m=e.shared.fps,r=1e3/m,f=Math.ceil(e.shared.delay_before_start/r),C=Math.ceil((l.at(-1).shared.enter_millisecond+e.shared.enter_duration+e.shared.lift_duration)/r),$=Math.ceil(e.shared.keep_after_end/r),L=f+C+$,b=H(e.shared.flow_direction),R={x:e.shared.main_axis==="vertical"||e.shared.flow_direction==="inverse"?0:t.width,y:e.shared.main_axis==="horizontal"||e.shared.flow_direction==="inverse"?0:t.height},V={topleft:{x:0,y:0},bottomright:{x:t.width,y:t.height}},k=await D.build(a,m,t);let p=0;for(s.clearRect(0,0,t.width,t.height),s.fillStyle=e.shared.background,s.fillRect(0,0,t.width,t.height),p=0;p<f;p++)await k.add_frame(s),o(p/L*100);const w=l.map(h=>({chat:h,ccb:void 0})),u=[],c={current_frame:0,current_time:0,time_delta:-1};let E=0,S=0;for(s.font=`${e.shared.chat_font_size}px "${e.shared.font_family}"`,s.textRendering="optimizeLegibility";c.current_frame<$+C;c.current_time+=r,c.current_frame+=1,c.time_delta=r){for(const n of w){const{chat:d,ccb:O}=n;if(c.current_time<d.shared.enter_millisecond)break;if(O)continue;const x=await e.shared.selected_theme.prepare_rendering(d,e,i),X=x instanceof Y?x.size:{height:x.render.height,width:x.render.width},z=K(X,e.shared.main_axis);u.push(new F({start:d.shared.enter_millisecond,end:d.shared.enter_millisecond+e.shared.lift_duration},{easing:q.ease_out_cubic,value:{start:0,end:z.length+e.shared.chat_margin}}));const P=B({length:E+e.shared.chat_margin+(b===1?z.length:0),breadth:0},e.shared.main_axis);n.ccb=new G(x,{x:R.x-b*P.width,y:R.y-b*P.height}),E+=e.shared.chat_margin+z.length}let h=0,A=S;for(const n of u){const d=n.get_value(c.current_time);A+=d,c.current_time>=n.time.end&&(S+=d,h++)}u.splice(0,h);const W=B({length:A*b,breadth:0},e.shared.main_axis),M=[];let j=0;for(const n of w){const{ccb:d}=n;if(d===void 0)break;j++,await d.update_position(W,V)?await d.free():M.push(n)}w.splice(0,j,...M.splice(0)),s.clearRect(0,0,t.width,t.height),s.fillStyle=e.shared.background,s.fillRect(0,0,t.width,t.height);for(const{ccb:n}of w){if(n===void 0)break;n.render(s,i,c)}for(const{ccb:n}of w){if(n===void 0)break;n.render_pass2(s,i,c)}await k.add_frame(s),p++,o(p/L*100)}for(const{ccb:h}of w)h!==void 0&&h.free();return(await(await k.close()).json()).name}const ie={name:"stack",display_name:"堆叠",preview:T,render:U};export{ie as default};
